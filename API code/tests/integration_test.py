import json
import pytest
from flask import Flask, url_for


def json_of_response(response):
    """Decode json from response"""
    return json.loads(response.data.decode('utf8'))


def test_auburn_json(client):
	result = client.get(url_for('auburn_values'))
	auburn_values = json_of_response(result)
	auburn_expected_values = {"ed_admits_no_specialty":[{"all_admits":15,"percentage":60.0,"transferred":9}],"ed_admits_specialty":[{"all_admits":6,"percentage":216.67,"transferred":13}],"ed_all_etp":[{"all_admits":21,"percentage":104.76,"transferred":22}],"expanded_four_twentyfour_speciality":[],"expanded_four_twentyfour_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_three_four_speciality":[],"expanded_three_four_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_two_three_speciality":[],"expanded_two_three_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_zero_two_speciality":[],"expanded_zero_two_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"general":[{"in_ed":0,"last_seven_days":3,"since_midnight":9}],"presentation_chart_data":[{"date":"01/09/2019","number":81},{"date":"02/09/2019","number":95},{"date":"03/09/2019","number":82},{"date":"04/09/2019","number":92},{"date":"05/09/2019","number":77},{"date":"06/09/2019","number":72},{"date":"07/09/2019","number":9}],"presentations":9,"ready_to_depart_to_discharged":[{"eight_up":2,"four_six":1,"six_eight":0,"two_four":1,"zero_two":16}],"triage":[{"five":2,"four":3,"one":0,"three":2,"two":2}],"waiting_in_ed_count":[{"departed":2,"not_seen":0,"not_triaged":0,"waiting_in_ed_count_total":0}],"waiting_in_ed_hours":[{"four_twentyfour":0,"three_four":0,"two_three":0,"zero_two":0}]}
	assert auburn_values == auburn_expected_values


def test_westmead_json(client):
	result = client.get(url_for('westmead_values'))
	westmead_values = json_of_response(result)
	westmead_expected_values = {"ed_admits_no_specialty":[{"all_admits":18,"percentage":0.0,"transferred":0}],"ed_admits_specialty":[{"all_admits":7,"percentage":100.0,"transferred":7}],"ed_all_etp":[{"all_admits":25,"percentage":28.0,"transferred":7}],"expanded_four_twentyfour_speciality":[],"expanded_four_twentyfour_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_three_four_speciality":[],"expanded_three_four_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_two_three_speciality":[],"expanded_two_three_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_zero_two_speciality":[],"expanded_zero_two_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"general":[{"in_ed":0,"last_seven_days":28,"since_midnight":11}],"presentation_chart_data":[{"date":"01/09/2019","number":128},{"date":"02/09/2019","number":119},{"date":"03/09/2019","number":124},{"date":"04/09/2019","number":115},{"date":"05/09/2019","number":106},{"date":"06/09/2019","number":124},{"date":"07/09/2019","number":11}],"presentations":11,"ready_to_depart_to_discharged":[{"eight_up":5,"four_six":2,"six_eight":0,"two_four":2,"zero_two":10}],"triage":[{"five":2,"four":6,"one":0,"three":1,"two":2}],"waiting_in_ed_count":[{"departed":3,"not_seen":0,"not_triaged":0,"waiting_in_ed_count_total":0}],"waiting_in_ed_hours":[{"four_twentyfour":0,"three_four":0,"two_three":0,"zero_two":0}]}
	
	assert westmead_values == westmead_expected_values

def test_blacktown_json(client):
	result = client.get(url_for('blacktown_values'))
	blacktown_values = json_of_response(result)
	blacktown_expected_values = {"ed_admits_no_specialty":[{"all_admits":20,"percentage":90.0,"transferred":18}],"ed_admits_specialty":[{"all_admits":17,"percentage":194.12,"transferred":33}],"ed_all_etp":[{"all_admits":37,"percentage":137.84,"transferred":51}],"expanded_four_twentyfour_speciality":[],"expanded_four_twentyfour_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_three_four_speciality":[],"expanded_three_four_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_two_three_speciality":[],"expanded_two_three_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_zero_two_speciality":[],"expanded_zero_two_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"general":[{"in_ed":1,"last_seven_days":32,"since_midnight":15}],"presentation_chart_data":[{"date":"01/09/2019","number":156},{"date":"02/09/2019","number":181},{"date":"03/09/2019","number":185},{"date":"04/09/2019","number":169},{"date":"05/09/2019","number":176},{"date":"06/09/2019","number":168},{"date":"07/09/2019","number":15}],"presentations":15,"ready_to_depart_to_discharged":[{"eight_up":13,"four_six":4,"six_eight":2,"two_four":3,"zero_two":11}],"triage":[{"five":0,"four":2,"one":0,"three":8,"two":5}],"waiting_in_ed_count":[{"departed":3,"not_seen":0,"not_triaged":1,"waiting_in_ed_count_total":1}],"waiting_in_ed_hours":[{"four_twentyfour":0,"three_four":0,"two_three":0,"zero_two":0}]}
	
	assert blacktown_values == blacktown_expected_values

def test_mtdruitt_json(client):
	result = client.get(url_for('mtdruitt_values'))
	mtdruitt_values = json_of_response(result)
	mtdruitt_expected_values = {"ed_admits_no_specialty":[{"all_admits":26,"percentage":19.23,"transferred":5}],"ed_admits_specialty":[{"all_admits":18,"percentage":100.0,"transferred":18}],"ed_all_etp":[{"all_admits":44,"percentage":52.27,"transferred":23}],"expanded_four_twentyfour_speciality":[],"expanded_four_twentyfour_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_three_four_speciality":[],"expanded_three_four_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_two_three_speciality":[],"expanded_two_three_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"expanded_zero_two_speciality":[],"expanded_zero_two_triage":[{"cat1":0,"cat2":0,"cat3":0,"cat4":0,"cat5":0,"unallocated":0}],"general":[{"in_ed":0,"last_seven_days":88,"since_midnight":13}],"presentation_chart_data":[{"date":"01/09/2019","number":215},{"date":"02/09/2019","number":237},{"date":"03/09/2019","number":221},{"date":"04/09/2019","number":198},{"date":"05/09/2019","number":215},{"date":"06/09/2019","number":226},{"date":"07/09/2019","number":13}],"presentations":13,"ready_to_depart_to_discharged":[{"eight_up":14,"four_six":3,"six_eight":2,"two_four":6,"zero_two":11}],"triage":[{"five":0,"four":3,"one":0,"three":6,"two":4}],"waiting_in_ed_count":[{"departed":8,"not_seen":3,"not_triaged":0,"waiting_in_ed_count_total":0}],"waiting_in_ed_hours":[{"four_twentyfour":0,"three_four":0,"two_three":0,"zero_two":0}]}
	
	assert mtdruitt_values == mtdruitt_expected_values

def test_comments(client):
	result = client.get(url_for('comment_handler'))
	comments = json_of_response(result)
	comments_expected = {"comment_0":[{"comment":"Westmead ED is experiencing huge influx of category five patients from a helicopter accident. Avoid sending patients here!","hospital":"Westmead","time":"09/27/2019, 00:23:00","userid":"AAAA1111"}],"comment_1":[{"comment":"Oh no! Blacktown hospital is almost empty. I wish I got to see that kind of action...","hospital":"Blacktown","time":"09/27/2019, 01:23:00","userid":"AAAA1111"}],"comment_10":[{"comment":"I'm not sure, it's my first year. Do you have any advice?","hospital":"Mt. Druitt","time":"09/27/2019, 10:23:00","userid":"BBBB4321"}],"comment_11":[{"comment":"My best advice would be to put your phone away and put pressure on the wound!","hospital":"Blacktown","time":"09/27/2019, 11:23:00","userid":"AAAA1234"}],"comment_12":[{"comment":"Sheesh! Interns these days...","hospital":"Auburn","time":"09/27/2019, 12:23:00","userid":"BBBB2222"}],"comment_13":[{"comment":"Yep, I know they do not make them like they used to hey!","hospital":"Blacktown","time":"09/27/2019, 13:23:00","userid":"CCCC3333"}],"comment_14":[{"comment":"Millenials, amirite!?!","hospital":"Auburn","time":"09/27/2019, 14:23:00","userid":"BBBB2222"}],"comment_15":[{"comment":"Auburn hospital is now experiencing massive amounts of ED patients for a flu outbreak!","hospital":"Auburn","time":"09/27/2019, 15:23:00","userid":"DDDD1111"}],"comment_16":[{"comment":"Almost 10+ patients are about to be waiting for over 16 hours for a consult, does anyone have a calm ED which I can reroute these patients to?","hospital":"Auburn","time":"09/27/2019, 16:23:00","userid":"DDDD1111"}],"comment_17":[{"comment":"Yes! Westmeand ED is now almost empty. You can advise them to come to us and we will prepare accordingly","hospital":"Westmead","time":"09/27/2019, 17:23:00","userid":"AAAA1111"}],"comment_18":[{"comment":"Great, thank you Auburn","hospital":"Blacktown","time":"09/27/2019, 18:23:00","userid":"DDDD4444"}],"comment_19":[{"comment":"Mt. Druitt also has a massive amount of flu patients - we will send some your way as well.","hospital":"Mt. Druitt","time":"09/27/2019, 19:23:00","userid":"BBBB2222"}],"comment_2":[{"comment":"I will begin to advise Cat. 3 and below patients to drive to Blacktown for treatment. Please prepare accordingly.","hospital":"Westmead","time":"09/27/2019, 02:23:00","userid":"AAAA1111"}],"comment_20":[{"comment":"Ok, sounds good.","hospital":"Westmead","time":"09/27/2019, 20:23:00","userid":"AAAA1111"}],"comment_21":[{"comment":"Everyone, please do not send additional flu patients our ED is now at capacity again.","hospital":"Westmead","time":"09/27/2019, 21:23:00","userid":"AAAA1111"}],"comment_22":[{"comment":"Alright, we've stopped redirecting patients. Thank you for helping it seriously reduced our ED waiting times for the afternoon.","hospital":"Mt. Druitt","time":"09/27/2019, 22:23:00","userid":"BBBB2222"}],"comment_23":[{"comment":"Uh oh, a landslide in the Blue Mountains has filled Mt. Druitt's ED out the door. Where can we best redirect patients?!?","hospital":"Mt. Druitt","time":"09/27/2019, 23:23:00","userid":"CCCC3333"}],"comment_24":[{"comment":"Send them to Blacktown, we are only at 30% capacity.","hospital":"Blacktown","time":"09/28/2019, 00:23:00","userid":"BBBB2222"}],"comment_25":[{"comment":"Any overflow from either Mt. Druitt or Blacktown can be send to Westmead too! We are at 20% capacity!","hospital":"Westmead","time":"09/28/2019, 01:23:00","userid":"AAAA1111"}],"comment_26":[{"comment":"hello This comment is added by Ab with Postman!","hospital":"Westmead","time":"10/31/2019, 22:37:29","userid":"Abhi"}],"comment_3":[{"comment":"Can you call the ambulance phone operators and advise ambulances to redirect to Blacktown as well if possible?","hospital":"Westmead","time":"09/27/2019, 03:23:00","userid":"AAAA1111"}],"comment_4":[{"comment":"Okie Dokie, we're ready bring it on!","hospital":"Blacktown","time":"09/27/2019, 04:23:00","userid":"BBBB2222"}],"comment_5":[{"comment":"Rodger dodger","hospital":"Westmead","time":"09/27/2019, 05:23:00","userid":"AAAA1111"}],"comment_6":[{"comment":"Mt. Druitt ED is also experience low ED volumes, you can redirect some patients here as well.","hospital":"Mt. Druitt","time":"09/27/2019, 06:23:00","userid":"BBBB2222"}],"comment_7":[{"comment":"I will advise the ambulance operators as well","hospital":"Mt. Druitt","time":"09/27/2019, 07:23:00","userid":"CCCC3333"}],"comment_8":[{"comment":"Gosh what a horrific helicopter crash. Only one of the thirty four victims have survived.","hospital":"Mt. Druitt","time":"09/27/2019, 08:23:00","userid":"CCCC3333"}],"comment_9":[{"comment":"Are you sure you guys are sewing them up correctly?","hospital":"Blacktown","time":"09/27/2019, 09:23:00","userid":"AAAA1234"}]}

	assert comments_expected == comments

# def test_definitions(client):
# 	result = client.get(url_for('definitions'))
# 	definitions = json_of_response(result)
# 	expected_definitions = {"159":[{"term_definition":"Count of the total number of patients admitted from ED to wards and the number of patients discharged from ED","term_formula":null,"term_name":"Total Discharges"}],"160":[{"term_definition":"Count of the number of patients admitted from ED who had an actual departure time less than 4 hours from their arrival and the number of discharged patients who had a departure ready time less than 4 hours from their arrival.","term_formula":null,"term_name":"DC or Admitted within 4hrs"}],"161":[{"term_definition":"Percentage of Patients discharged or admitted within 4hrs as a proportion of Total Discharges from ED","term_formula":null,"term_name":"Total ETP"}],"162":[{"term_definition":"Count of the number of patients discharged from ED","term_formula":null,"term_name":"All Non Admits"}],"163":[{"term_definition":"Count of the number of patients discharged from ED who had an actual departure ready time less than 4 hours from their arrival.","term_formula":null,"term_name":"Non Admits DC within 4hrs"}],"164":[{"term_definition":"Percentage of Patients Discharged from ED within 4hrs as a proportion of All ED Non Admissions.","term_formula":null,"term_name":"Non Admit ETP%"}],"165":[{"term_definition":"Count of the number of patients admitted from ED to wards","term_formula":null,"term_name":"All Admits"}],"166":[{"term_definition":"Count of the number of patients admitted from ED to wards who had an actual departure time less than 4 hours from their arrival","term_formula":null,"term_name":"Transferred to ward within 4hrs"}],"167":[{"term_definition":"Percentage of Patients transferred from ED to ward within 4hrs as a proportion of All ED Admissions","term_formula":null,"term_name":"Admit ETP%"}],"168":[{"term_definition":"Count of the number of patients transferred from ED to ED Speciality Wards","term_formula":null,"term_name":"All Admits"}],"169":[{"term_definition":"Count of the number of patients admitted from ED to wards who had an actual departure time less than 4 hours from their arrival","term_formula":null,"term_name":"Transferred to ward within 4hrs"}],"170":[{"term_definition":"Percentage of Patients transferred from ED to ED Speciality Wards within 4hrs as a proportion of All ED Admissions to ED Speciality Wards","term_formula":null,"term_name":"Admit ETP%"}],"171":[{"term_definition":"Count of the number of patients transferred from ED to ED Non Speciality Wards","term_formula":null,"term_name":"All Admits"}],"172":[{"term_definition":"Count of the number of patients transferred from ED to ED Non Speciality Wards  who had an actual departure time less than 4 hours from their arrival","term_formula":null,"term_name":"Transferred to ward within 4hrs"}],"173":[{"term_definition":"Percentage of Patients transferred from ED to ED Non Speciality Wards within 4hrs as a proportion of All ED Admissions to ED Non Speciality Wards","term_formula":null,"term_name":"Admit ETP%"}],"178":[{"term_definition":"View all patients","term_formula":"99.0","term_name":"ViewAll"}],"195":[{"term_definition":"The time when patient arrived in ED","term_formula":null,"term_name":"Arrival Date-time "}],"196":[{"term_definition":"ED presentation reason","term_formula":null,"term_name":"Admit Reason"}],"197":[{"term_definition":"The time when a valid triage is assigned to the patient","term_formula":null,"term_name":"Triage Date-time  "}],"198":[{"term_definition":"Valid category assigned to a patient after triage","term_formula":null,"term_name":"Triage Category"}],"199":[{"term_definition":"The time when a patient was first examined by  doctor/nurse","term_formula":null,"term_name":"Seen by Date-time  "}],"200":[{"term_definition":"The time when decision to admitted was requested.  1st discussion could be 'to be admit' or 'to be discharge'","term_formula":null,"term_name":"DTA Date-time"}],"201":[{"term_definition":"The time when patient is ready to depart either discharge from ED or admit to ward","term_formula":null,"term_name":"Ready To Depart Date-time"}],"202":[{"term_definition":"The time when patient left the ED. Either discharged from ED or admitted to the ward. This time will be the earliest of discharge time and checkout time","term_formula":null,"term_name":"Checkout Date-time"}],"203":[{"term_definition":"Mode of separation from ED","term_formula":null,"term_name":"Discharge Disposition "}],"204":[{"term_definition":"Speciality where admitted patient was  moved from ED","term_formula":null,"term_name":"Speciality"}],"205":[{"term_definition":"The time patient spend in ED from Arrival to checkout/Discharge.","term_formula":null,"term_name":"LOS"}],"206":[{"term_definition":"LOS of patient in less than 2 hours. in  ED","term_formula":null,"term_name":"Green"}],"207":[{"term_definition":"LOS of patient is between 2 \ufffd 3 hours in ED","term_formula":null,"term_name":"Amber"}],"208":[{"term_definition":"LOS of patient I between 3-4 hours is ED","term_formula":null,"term_name":"SoftRed"}],"209":[{"term_definition":"LOS of patient is between 4-24 hours in ED","term_formula":null,"term_name":"Red"}],"210":[{"term_definition":"This represents current ED status.  It is derived based on number of patient currently in ED and it is represented by three colour (Green, Amber, Red) .Count will also include patient in ED from last 7 days.\nED Status:\n  GREEN: When there are less than 35 patients in the ED.\n  AMBER: When there is between 35-70 patients in the ED.\n  RED: when there are more than 70 patients in ED.  ","term_formula":null,"term_name":"ED Status"}],"211":[{"term_definition":"Count of number of patient presented in ED since midnight. This will not include patient from previous days.","term_formula":null,"term_name":"ED Presentation"}],"212":[{"term_definition":"Count of number of patient currently in ED. The count is the sum of patient in ED since midnight and patient in ED from last 7 days.","term_formula":null,"term_name":"Patient Currently In ED"}],"213":[{"term_definition":"Count of number of patient waiting for treatment to commence. This will includes number of patient Registered but not yet Triaged and number of patient Triaged but not yet Seen by Doctor or Nurse","term_formula":null,"term_name":"Waiting In ED"}],"214":[{"term_definition":"Count of number of patient who are ready to depart but not yet discharged.","term_formula":null,"term_name":"Ready To Depart"}],"215":[{"term_definition":"Count of number of available bed from ED accessible beds.","term_formula":null,"term_name":"Total ED Available Beds "}],"216":[{"term_definition":"List of ED accessible wards","term_formula":null,"term_name":"Ward"}],"217":[{"term_definition":"Total number of ED accessible beds in Ward.","term_formula":null,"term_name":"Accessible Beds Count"}],"218":[{"term_definition":"Total number of occupied beds in Ward.","term_formula":null,"term_name":"Occupied Beds Count"}],"219":[{"term_definition":"Total number of available beds in  Ward. It\ufffds a difference of accessible beds and Occupied beds.","term_formula":null,"term_name":"Available Beds Count"}],"220":[{"term_definition":"Count of number of ED presentations, classification of triage category. Presentations with invalid triage category are  classified as 'Unallocated' triage.","term_formula":null,"term_name":"Triage Presentation"}],"221":[{"term_definition":"Count of number of  patient discharged  from ED today, after 24 hrs","term_formula":null,"term_name":"Discharge after 24 hours"}]}
# 	assert definitions == expected_definitions

